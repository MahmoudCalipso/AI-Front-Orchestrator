<div class="ide-container">
    <mat-toolbar class="ide-toolbar">
        <button mat-icon-button>
            <mat-icon>menu</mat-icon>
        </button>
        <span class="toolbar-title">
            <mat-icon>code</mat-icon>
            AI Orchestrator IDE
        </span>
        <span class="spacer"></span>
        <button mat-icon-button (click)="saveFile()" [disabled]="!getActiveGroup()?.activeFile"
            matTooltip="Save File (Ctrl+S)">
            <mat-icon>save</mat-icon>
        </button>
        <button mat-icon-button (click)="formatCode()" [disabled]="!getActiveGroup()?.activeFile"
            matTooltip="Format Code">
            <mat-icon>format_align_left</mat-icon>
        </button>
        <button mat-flat-button color="primary" (click)="runCode()">
            <mat-icon>play_arrow</mat-icon>
            Run
        </button>
        <span class="spacer-sm"></span>
        <button mat-icon-button (click)="toggleGit()" [class.accent-color]="isGitOpen"
            matTooltip="Toggle Source Control">
            <mat-icon>source_control</mat-icon>
        </button>
        <button mat-icon-button (click)="toggleK8s()" [class.accent-color]="isK8sOpen"
            matTooltip="Toggle Kubernetes Explorer">
            <mat-icon>cloud</mat-icon>
        </button>
        <button mat-icon-button (click)="toggleSearch()" [class.accent-color]="isSearchOpen" matTooltip="Toggle Search">
            <mat-icon>search</mat-icon>
        </button>
        <button mat-icon-button (click)="toggleChat()" [class.accent-color]="isChatOpen" matTooltip="Toggle AI Chat">
            <mat-icon>chat</mat-icon>
        </button>
    </mat-toolbar>

    <mat-sidenav-container class="ide-container">
        <!-- File Explorer -->
        <mat-sidenav mode="side" opened class="file-explorer" [style.width.px]="explorerWidth">
            <div class="explorer-header">
                <span>Explorer</span>
            </div>
            <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
                <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
                    <button mat-icon-button disabled></button>
                    <div class="file-node" (click)="openFile(node)">
                        <mat-icon class="type-icon">{{ node.isDirectory ? 'folder' : 'description' }}</mat-icon>
                        {{ node.name }}
                    </div>
                </mat-tree-node>
                <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
                    <button mat-icon-button matTreeNodeToggle>
                        <mat-icon class="mat-icon-rtl-mirror">
                            {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
                        </mat-icon>
                    </button>
                    <div class="file-node" (click)="openFile(node)">
                        <mat-icon class="type-icon">folder</mat-icon>
                        {{ node.name }}
                    </div>
                </mat-tree-node>
            </mat-tree>
        </mat-sidenav>

        <!-- Resize Gutter (Left) -->
        <div class="resize-gutter vertical" (mousedown)="startResizing($event, 'explorer')"></div>

        <!-- Git Sidebar -->
        <mat-sidenav position="start" mode="side" [opened]="isGitOpen" class="git-sidebar" [style.width.px]="gitWidth">
            <app-git-window [workspaceId]="workspaceId" [localPath]="'/workspaces/' + workspaceId"
                (openDiff)="handleGitDiff($event)" (statusChanged)="handleGitStatusChange()"></app-git-window>
        </mat-sidenav>

        <!-- K8s Sidebar -->
        <mat-sidenav position="start" mode="side" [opened]="isK8sOpen" class="k8s-sidebar" [style.width.px]="k8sWidth">
            <app-k8s-window></app-k8s-window>
        </mat-sidenav>

        <!-- Search Sidebar -->
        <mat-sidenav position="start" mode="side" [opened]="isSearchOpen" class="search-sidebar"
            [style.width.px]="searchWidth">
            <app-search-window [workspaceId]="workspaceId" (openFile)="openFile($event)"></app-search-window>
        </mat-sidenav>

        <!-- Right Chat Sidebar -->
        <mat-sidenav position="end" mode="side" [opened]="isChatOpen" class="chat-sidebar" [style.width.px]="chatWidth">
            <app-ide-chat [workspaceId]="workspaceId" [contextFile]="getActiveGroup()?.activeFile?.name || null"
                (closeChat)="toggleChat()" (applyChange)="handleAiApply($event)">
            </app-ide-chat>
        </mat-sidenav>

        <!-- Resize Gutter (Right) -->
        @if (isChatOpen || isGitOpen || isSearchOpen) {
        <div class="resize-gutter vertical right"
            (mousedown)="startResizing($event, isChatOpen ? 'chat' : (isGitOpen ? 'git' : 'search'))">
        </div>
        }

        <!-- Main Content -->
        <mat-sidenav-content class="ide-content">
            <!-- Editor Area -->
            <div class="editor-area">
                <div class="editor-groups-container">
                    @for (group of editorGroups; track group.id) {
                    <div class="editor-group" [class.active-group]="group.id === activeGroupId"
                        (click)="activeGroupId = group.id">

                        <div class="group-header">
                            <div class="tabs-container">
                                @for (file of group.files; track file.path) {
                                <div class="editor-tab" [class.active]="group.activeFile?.path === file.path"
                                    (click)="setActiveFile(file, group)">
                                    <span class="file-name">{{ file.name }}</span>
                                    <span class="close-icon" (click)="closeFile(file, group, $event)">Ã—</span>
                                </div>
                                }
                            </div>
                            <div class="group-actions">
                                <button mat-icon-button (click)="splitEditor('vertical')" matTooltip="Split Right">
                                    <mat-icon>vertical_split</mat-icon>
                                </button>
                                @if (editorGroups.length > 1) {
                                <button mat-icon-button (click)="closeEditorGroup(group.id)" matTooltip="Close Group">
                                    <mat-icon>close</mat-icon>
                                </button>
                                }
                            </div>
                        </div>

                        @defer (on viewport) {
                        <div class="monaco-container" #editorContainer></div>
                        } @placeholder {
                        <div class="editor-skeleton">
                            <div class="shine"></div>
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>

            <!-- Resize Gutter (Bottom) -->
            <div class="resize-gutter horizontal" (mousedown)="startResizing($event, 'bottom')"></div>

            <!-- Bottom Panel -->
            <div class="bottom-panel" [style.height.px]="bottomPanelHeight">
                <mat-tab-group>
                    <mat-tab label="Terminal">
                        @defer (on timer(500ms)) {
                        <div #terminalContainer class="terminal-container"></div>
                        } @placeholder {
                        <div class="terminal-loading">Initializing Terminal...</div>
                        }
                    </mat-tab>
                    <mat-tab label="Problems">
                        <div class="problems-panel">
                            <p class="empty-state">No problems detected</p>
                        </div>
                    </mat-tab>
                    <mat-tab label="Output">
                        <div class="output-panel">
                            <p class="empty-state">No output</p>
                        </div>
                    </mat-tab>
                    <mat-tab label="Debug Console">
                        <div class="debug-panel">
                            <p class="empty-state">Debugger not active</p>
                        </div>
                    </mat-tab>
                </mat-tab-group>
            </div>
        </mat-sidenav-content>
    </mat-sidenav-container>

    <!-- Phase 5: Command Palette -->
    <app-command-palette></app-command-palette>
</div>