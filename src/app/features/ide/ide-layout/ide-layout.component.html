<div class="ide-container">
    <mat-toolbar class="ide-toolbar">
        <button mat-icon-button>
            <mat-icon>menu</mat-icon>
        </button>
        <span class="toolbar-title">
            <mat-icon>code</mat-icon>
            AI Orchestrator IDE
        </span>
        <span class="spacer"></span>
        <button mat-icon-button (click)="saveFile()" [disabled]="!getActiveGroup()?.activeFile"
            matTooltip="Save File (Ctrl+S)">
            <mat-icon>save</mat-icon>
        </button>
        <button mat-icon-button (click)="formatCode()" [disabled]="!getActiveGroup()?.activeFile"
            matTooltip="Format Code">
            <mat-icon>format_align_left</mat-icon>
        </button>
        <button mat-flat-button color="primary" (click)="runCode()">
            <mat-icon>play_arrow</mat-icon>
            Run
        </button>
        <span class="spacer-sm"></span>
        <button mat-icon-button (click)="toggleChat()" [class.accent-color]="isChatOpen" matTooltip="Toggle AI Chat">
            <mat-icon>chat</mat-icon>
        </button>
    </mat-toolbar>

    <mat-sidenav-container class="ide-container">
        <!-- File Explorer -->
        <mat-sidenav mode="side" opened class="file-explorer">
            <div class="explorer-header">
                <span>Explorer</span>
            </div>
            <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
                <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
                    <button mat-icon-button disabled></button>
                    <div class="file-node" (click)="openFile(node)">
                        <mat-icon class="type-icon">{{ node.isDirectory ? 'folder' : 'description' }}</mat-icon>
                        {{ node.name }}
                    </div>
                </mat-tree-node>
                <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
                    <button mat-icon-button matTreeNodeToggle>
                        <mat-icon class="mat-icon-rtl-mirror">
                            {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
                        </mat-icon>
                    </button>
                    <div class="file-node" (click)="openFile(node)">
                        <mat-icon class="type-icon">folder</mat-icon>
                        {{ node.name }}
                    </div>
                </mat-tree-node>
            </mat-tree>
        </mat-sidenav>

        <!-- Right Chat Sidebar -->
        <mat-sidenav position="end" mode="side" [opened]="isChatOpen" class="chat-sidebar">
            <app-ide-chat [contextFile]="getActiveGroup()?.activeFile?.name || null" (closeChat)="toggleChat()">
            </app-ide-chat>
        </mat-sidenav>

        <!-- Main Content -->
        <mat-sidenav-content class="ide-content">
            <!-- Editor Area with Split Support -->
            <div class="editor-area">
                <div class="editor-groups-container">
                    <div class="editor-group" *ngFor="let group of editorGroups"
                        [class.active-group]="group.id === activeGroupId" (click)="activeGroupId = group.id">

                        <!-- Group Header (Tabs & Actions) -->
                        <div class="group-header">
                            <div class="tabs-container">
                                <div class="editor-tab" *ngFor="let file of group.files"
                                    [class.active]="group.activeFile?.path === file.path"
                                    (click)="setActiveFile(file, group)">
                                    <span class="file-name">{{ file.name }}</span>
                                    <span class="close-icon" (click)="closeFile(file, group, $event)">Ã—</span>
                                </div>
                            </div>
                            <div class="group-actions">
                                <button mat-icon-button (click)="splitEditor('vertical')" matTooltip="Split Right">
                                    <mat-icon>vertical_split</mat-icon>
                                </button>
                                <button mat-icon-button *ngIf="editorGroups.length > 1"
                                    (click)="closeEditorGroup(group.id)" matTooltip="Close Group">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        </div>

                        <!-- Monaco Editor Instance -->
                        <div class="monaco-container" #editorContainer></div>
                    </div>
                </div>
            </div>

            <div class="editor-panel">
                <div #editorContainer class="monaco-editor-container"></div>
            </div>

            <!-- Bottom Panel -->
            <div class="bottom-panel">
                <mat-tab-group>
                    <mat-tab label="Terminal">
                        <div #terminalContainer class="terminal-container">
                            <div class="terminal-placeholder">
                                <mat-icon>terminal</mat-icon>
                                <p>Terminal (xterm.js integration coming soon)</p>
                                <p class="terminal-demo">$ npm install</p>
                                <p class="terminal-demo">$ npm run dev</p>
                            </div>
                        </div>
                    </mat-tab>
                    <mat-tab label="Problems">
                        <div class="problems-panel">
                            <p class="empty-state">No problems detected</p>
                        </div>
                    </mat-tab>
                    <mat-tab label="Output">
                        <div class="output-panel">
                            <p class="empty-state">No output</p>
                        </div>
                    </mat-tab>
                    <mat-tab label="Debug Console">
                        <div class="debug-panel">
                            <p class="empty-state">Debugger not active</p>
                        </div>
                    </mat-tab>
                </mat-tab-group>
            </div>
        </mat-sidenav-content>
    </mat-sidenav-container>
</div>