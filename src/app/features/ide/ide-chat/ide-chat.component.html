<div class="chat-container">
    <div class="chat-header">
        <h3>AI Assistant</h3>
        <div class="header-actions">
            <button mat-icon-button (click)="clearChat()" matTooltip="Clear Chat">
                <mat-icon>delete_outline</mat-icon>
            </button>
            <button mat-icon-button (click)="closeChat.emit()" matTooltip="Close">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>

    <div class="messages-list">
        @for (msg of messages; track msg.timestamp) {
        <div class="message-bubble" [class.user]="msg.role === 'user'" [class.ai]="msg.role === 'ai'">
            <div class="message-avatar">
                <mat-icon>{{ msg.role === 'user' ? 'person' : 'smart_toy' }}</mat-icon>
            </div>
            <div class="message-content">
                <div class="message-text" [innerHTML]="msg.content | safeHtml"></div>

                @if (msg.isAgentic && msg.codeSnippet) {
                <div class="agentic-block">
                    <div appHighlight [code]="msg.codeSnippet" language="typescript"></div>
                    <button mat-flat-button color="accent" size="small" (click)="applySuggestion(msg.codeSnippet)">
                        <mat-icon>done_all</mat-icon>
                        Apply Changes
                    </button>
                </div>
                }

                <div class="message-time">{{ msg.timestamp | date:'shortTime' }}</div>
            </div>
        </div>
        }

        @if (isThinking) {
        <div class="thinking-bubble">
            <mat-spinner diameter="20"></mat-spinner>
            <span>AI is thinking...</span>
        </div>
        }
    </div>

    <div class="input-area">
        @if (contextFile) {
        <div class="context-indicator">
            <mat-icon>description</mat-icon>
            <span>Context: {{ contextFile }}</span>
        </div>
        }
        <div class="input-wrapper">
            <textarea [(ngModel)]="userInput" (keyup.enter)="sendMessage()"
                placeholder="Ask anything about your code..." rows="1"></textarea>
            <button mat-icon-button color="primary" (click)="sendMessage()"
                [disabled]="!userInput.trim() || isThinking">
                <mat-icon>send</mat-icon>
            </button>
        </div>
    </div>
</div>